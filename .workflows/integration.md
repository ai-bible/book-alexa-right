# Integration Guide: Planning ↔ Generation

Документ описывает, как Planning Workflow и Generation Workflow связаны и работают вместе.

## Обзор связи

```
PLANNING WORKFLOW                    GENERATION WORKFLOW
        ↓                                    ↓
Интерактивное                        Многоэтапная генерация
планирование                         с валидацией
        ↓                                    ↓
    Blueprint ───────────────────────→   Финальная сцена
    (детальный план)                     (литературный текст)
```

## Точки интеграции

### 1. Blueprint как мост

Blueprint - это ключевая точка интеграции. Он создаётся в Planning Workflow и используется как входные данные для Generation Workflow.

**Формат blueprint**:
```markdown
## BLUEPRINT СЦЕНЫ: [Название]

### Сюжетная цель
[Что должно быть достигнуто в сюжете]

### Структура
**Тип**: Сцена (Цель-Конфликт-Катастрофа) / Продолжение (Реакция-Дилемма-Решение)

[Детальная структура]

### Временные параметры
- Время начала: [конкретное время]
- Продолжительность: [примерно]
- Место в хронологии: [День X, после события Y]

### Локация и атмосфера
**Место**: [название локации]
**Атмосфера**: [описание]

### Ключевые элементы мира
- [Элемент 1] (Канон уровень X): [как используется]
- [Элемент 2] (Канон уровень X): [как используется]

### Участники
1. **[Персонаж 1]**
   - Эмоциональное состояние: [вход] → [выход]
   - Мотивация: [описание]
   - Цель в сцене: [если применимо]

2. **[Персонаж 2]**
   - Эмоциональное состояние: [вход] → [выход]
   - Мотивация: [описание]

### Ключевые биты сцены
1. [Бит 1]: [описание]
2. [Бит 2]: [описание]
3. [Бит 3]: [описание]

### Диалоговые точки
1. [Точка 1]: [тема, информация]
2. [Точка 2]: [тема, информация]

### Подтексты и намёки
- [Подтекст 1]
- [Форшадоуинг]: [намёк на будущее]

### Ограничения
- Канон: [ограничения]
- Информация: [что персонажи НЕ могут знать]
- Временные: [временные рамки]

### Техническое задание для Writer
- Объём: ~3000-5000 символов
- Стиль: [указания]
- Акценты: [на что обратить внимание]
```

**Путь**: `/acts/act-[N]/chapters/chapter-[M]/scenes/scene-[K]-blueprint.md`

### 2. Передача управления

#### Сценарий А: Последовательная работа

```
Пользователь запускает Planning:
    ↓
/plan-story
    ↓
Интерактивное планирование
    ↓
Blueprint создан и сохранён
    ↓
Пользователь получает уведомление: "Blueprint готов: [путь]"
    ↓
Пользователь запускает Generation:
"Сгенерируй сцену из blueprint [путь]"
    ↓
Generation Workflow начинает с этапа 6
```

#### Сценарий Б: Генерация без предварительного планирования

```
Пользователь:
"Создай сцену, где Хронос встречается с Лин"
    ↓
Generation Workflow определяет: нет blueprint
    ↓
Проходит этапы 0-5 (создание blueprint на лету)
    ↓
Продолжает с этапа 6 (генерация)
```

### 3. Общие контексты

Оба workflow используют одни и те же контексты:

```
/context
├── characters/          # Персонажи
├── world-bible/         # Библия мира
├── canon-levels/        # Уровни канона
├── plot-graph/          # Сюжетный граф
└── timeline/            # Хронология
```

**Правило**: Оба workflow **читают** из этих контекстов, но только Generation Workflow (этап 11) **пишет** обновления.

### 4. Обновление планов после генерации

После того как сцена сгенерирована и интегрирована:

```
Generation завершён (этап 11)
    ↓
Контексты обновлены
    ↓
Planning Workflow при следующем запуске
    ↓
Использует обновлённые контексты
    ↓
Учитывает уже написанное при планировании следующих сцен
```

## Рабочие паттерны

### Паттерн 1: Bottom-Up (Сцена за сценой)

Подходит для исследовательского написания.

```
1. /plan-story → планируешь сцену 1
2. Генерируешь сцену 1
3. Читаешь результат
4. /plan-story → планируешь сцену 2 (с учётом результата сцены 1)
5. Генерируешь сцену 2
...и так далее
```

**Плюсы**:
- Гибкость: можешь менять направление по ходу
- Органичность: сюжет развивается естественно

**Минусы**:
- Риск потери общей арки
- Может потребоваться больше переписываний

### Паттерн 2: Top-Down (От акта к сценам)

Подходит для структурированного написания.

```
1. /plan-story → планируешь весь акт 1
2. /plan-story → детализируешь главу 1
3. /plan-story → планируешь все сцены главы 1
4. Генерируешь сцены 1.1, 1.2, 1.3... последовательно
5. Переходишь к главе 2
```

**Плюсы**:
- Чёткая структура
- Меньше риска противоречий
- Видна общая картина

**Минусы**:
- Менее гибко
- Требует больше планирования заранее

### Паттерн 3: Hybrid (Смешанный)

Комбинирует оба подхода.

```
1. /plan-story → планируешь акт 1 (крупные штрихи)
2. /plan-story → планируешь главу 1 детально
3. Генерируешь сцены главы 1
4. Оцениваешь результат
5. Корректируешь план главы 2 на основе написанного
6. Продолжаешь
```

**Плюсы**:
- Баланс структуры и гибкости
- Адаптивность

**Минусы**:
- Требует дисциплины
- Нужно следить за согласованностью

## Обработка изменений

### Когда план меняется после написания

```
Ситуация: Написал главы 1-3, но хочешь изменить план акта
    ↓
1. Обновляешь strategic plan
   (создаётся strategic-plan-v2.md)
    ↓
2. Запускаешь /check-consistency
    ↓
3. Получаешь TODO-лист:
   - Какие главы требуют переписывания
   - Какие сцены требуют проверки
    ↓
4. Принимаешь решение:
   - Переписать сейчас
   - Отложить на редактуру
   - Продолжить с новым планом
    ↓
5. Если переписываешь:
   - Обновляешь blueprint
   - Запускаешь генерацию заново
```

### Версионирование планов

```
/acts/act-1/
├── strategic-plan.md        # Текущий
├── strategic-plan-v2.md     # После изменения
├── strategic-plan-v3.md     # После ещё одного изменения
└── CHANGELOG.md             # История изменений
```

**CHANGELOG.md формат**:
```markdown
## Version 3 (2025-XX-XX)
- Изменено: Мотивация Хроноса в середине акта
- Добавлено: Новая сюжетная линия с Прогностиком
- Затронуто: Главы 4-6
- TODO: Обновить сцены 4.2, 5.1, 6.3

## Version 2 (2025-XX-XX)
...
```

## Согласование сюжетных линий

### Character Knowledge Timeline

Критически важно для обоих workflow:

```
/context/characters/chronos/knowledge-timeline.md

## ХРОНОЛОГИЯ ЗНАНИЙ: Chronos

### До Главы 1
Знает:
- Существование проекта "Зеркало"
- Свою роль в Корпорации

Не знает:
- О повышении синхронизации
- О истинных целях Совета

### Глава 1, Сцена 2
Узнаёт:
- О встрече Совета (из приглашения)

### Глава 3, Сцена 1
Узнаёт:
- О повышении синхронизации до 97%
- О потенциальной опасности для людей

...
```

**Использование**:

**В Planning**: Проверяется при планировании диалогов и действий
**В Generation**: character-state читает для определения состояния

## Работа со storylines

### Создание в Planning

```bash
/storyline create chronos
```

Создаёт: `/acts/act-1/storylines/chronos-main.md`

### Использование в Generation

При генерации сцены:

```
character-state читает storyline
    ↓
Определяет: где персонаж в своей дуге
    ↓
Использует для определения мотивации и эмоций
```

### Обновление после генерации

```
Generation завершён (этап 11)
    ↓
plot-architect обновляет storyline
    ↓
Отмечает прогресс дуги
    ↓
Следующая сцена использует обновлённую версию
```

## Coordination агентов между workflows

### Общие агенты

Некоторые агенты работают в **обоих** workflows:

- **plot-architect**: Planning (фаза 3) + Generation (этап 1, 7, 11)
- **character-state**: Planning (фаза 4) + Generation (этап 4, 7)
- **world-lorekeeper**: Planning (фаза 5) + Generation (этап 3, 7, 11)
- **canon-guardian**: Planning (фаза 2, 5) + Generation (этап 3, 7, 11)

**Важно**: Агенты работают **с одними и теми же контекстами**, обеспечивая согласованность.

### Специализированные агенты

**Только Planning**:
- planning-coordinator
- context-analyzer
- scenario-generator
- consequence-predictor
- world-impact-analyzer
- arc-planner
- dependency-mapper
- emotional-arc-designer
- beat-planner
- character-knowledge-updater
- storyline-integrator
- impact-analyzer
- storyline-developer
- consistency-checker
- dialogue-weaver

**Только Generation**:
- director
- scene-structure
- chronicle-keeper
- sci-fi-world-writer
- dialogue-choreographer
- dialogue-analyst

## Best Practices

### При планировании

1. **Планируй достаточно, но не слишком**
   - Strategic plan: крупные штрихи
   - Chapter plan: средняя детализация
   - Scene blueprint: детально

2. **Оставляй место для импровизации**
   - Не планируй каждое слово диалога
   - Оставь возможность для органичных деталей

3. **Используй storylines**
   - Создавай линии для ключевых персонажей
   - Обращайся к ним при планировании сцен

### При генерации

1. **Доверяй blueprint**
   - Если blueprint детальный, writer следует ему
   - Если blueprint гибкий, writer импровизирует в рамках

2. **Утверждай новые элементы**
   - Всегда проверяй новые элементы мира
   - Определяй уровень канона сразу

3. **Используй итерации**
   - Не стремись к идеалу с первого раза
   - Лучше 2-3 итерации с улучшениями

### После генерации

1. **Обновляй контексты**
   - Всегда завершай этап 11 (интеграция)
   - Не пропускай обновление character knowledge

2. **Проверяй согласованность**
   - Если менял план, запускай /check-consistency
   - Следи за TODO-листом

3. **Сохраняй версии**
   - Версионируй планы при изменениях
   - Веди CHANGELOG

## Troubleshooting

### Проблема: Blueprint слишком детальный, текст получается механическим

**Решение**: Уменьши детализацию в Planning. Используй:
- Фаза 1-3: детально
- Фаза 4-5: крупными штрихами
- Дай writer больше свободы

### Проблема: Blueprint слишком общий, writer не понимает, что писать

**Решение**: Увеличь детализацию в Planning. Добавь:
- Конкретные биты сцены (beat-planner)
- Ключевые диалоговые точки
- Конкретные элементы мира

### Проблема: Планировал одно, получилось другое

**Решение**: 
- Проверь, следует ли writer blueprint (может быть bug в промпте)
- Если writer импровизировал удачно - обнови план
- Если неудачно - используй итерацию с более строгими указаниями

### Проблема: Противоречия между сценами

**Решение**:
- Запусти /check-consistency
- Проверь character knowledge timeline
- Обнови проблемные сцены

### Проблема: Потерял общую арку при написании

**Решение**:
- Вернись к strategic plan
- Запусти /storyline query для ключевых персонажей
- Проверь, где ты в процентах повествования
- Скорректируй планы следующих глав

## Metrics и мониторинг

### Отслеживай

1. **Соотношение планирования к генерации**
   - Идеально: ~30-40% времени на планирование, 60-70% на генерацию
   - Если больше планируешь - возможно, overplanning
   - Если больше генерируешь - возможно, underplanning

2. **Количество итераций**
   - 1 итерация: отлично
   - 2-3 итерации: нормально
   - >3 итераций: возможно, проблема с blueprint

3. **Количество изменений планов**
   - 1-2 версии плана акта: нормально
   - >3 версий: возможно, недостаточно продумано заранее

4. **Количество новых элементов мира на сцену**
   - 0-2: оптимально
   - 3-5: много, но допустимо
   - >5: возможно, перегрузка

---

**Версия**: 1.0  
**Связанные документы**:
- [Planning Workflow](planning.md)
- [Generation Workflow](generation.md)
- [Agents Reference](agents-reference.md)